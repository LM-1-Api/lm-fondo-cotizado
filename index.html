<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LM Fondo Cotizado · USD</title>
  <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root{
      --lm-bg:#1a1a1a; --lm-card:#101010; --lm-gold:#c6a663;
      --lm-green:#00c853; --lm-red:#d32f2f; --lm-text:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#1a1a1a;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}

    .topbar{background:#000;border-bottom:1px solid rgba(198,166,99,.35);
      padding:14px 16px 8px;display:flex;align-items:center;gap:10px}
    .top-title{font-weight:800;letter-spacing:.04em}
    .top-tickers{margin-left:auto;display:flex;gap:20px}
    .tk{font-size:13px}.tk label{opacity:.6;margin-right:4px}.tk span{color:var(--lm-green);font-weight:800}

    .wrap{padding:12px 10px 70px;display:flex;flex-direction:column;gap:14px}
    .card{background:#0d0d0d;border:1px solid rgba(198,166,99,.35);border-radius:26px;overflow:hidden}
    .card-head{padding:16px 16px 6px}
    .title-sm{font-size:15px;font-weight:800;letter-spacing:.02em}
    .subtitle{font-size:13px;opacity:.65}
    .big-price{font-size:40px;font-weight:900;color:var(--lm-green);margin:8px 0 12px}
    .tf-row{display:flex;gap:8px;margin-bottom:12px}
    .tf-btn{background:#000;border:1px solid transparent;color:#fff;border-radius:14px;padding:6px 12px;font-size:14px}
    .tf-btn.active{border-color:var(--lm-gold);background:rgba(198,166,99,.12)}

    .chart-container{position:relative;height:300px;background:#111}
    .chart-box{position:absolute;inset:0}
    .lm-watermark{position:absolute;left:10px;bottom:10px;width:34px;height:34px;opacity:.9;
      object-fit:contain;pointer-events:none;z-index:2;filter:drop-shadow(0 0 2px rgba(0,0,0,.6))}
    .chart-footer{background:#000;padding:10px 14px 14px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .brand{font-weight:900}
    .ts{opacity:.85}
    @media(min-width:820px){.wrap{max-width:1180px;margin:0 auto}}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="top-title">LM Fondo Cotizado · USD</div>
    <div class="top-tickers">
      <div class="tk"><label>ORO</label><span id="tk-gold">$--</span></div>
      <div class="tk"><label>PLATA</label><span id="tk-silver">$--</span></div>
    </div>
  </div>

  <div class="wrap">
    <!-- ====== ORO ====== -->
    <div class="card" id="gold-card">
      <div class="card-head">
        <div class="title-sm">ORO (XAU/USD)</div>
        <div class="subtitle">Tiempo real · LM Fondo Cotizado</div>
        <div class="big-price" id="gold-price">$--</div>
        <div class="tf-row" data-metal="XAU">
          <button class="tf-btn active" data-tf="1m">1m</button>
          <button class="tf-btn" data-tf="5m">5m</button>
          <button class="tf-btn" data-tf="15m">15m</button>
          <button class="tf-btn" data-tf="1h">1h</button>
          <button class="tf-btn" data-tf="4h">4h</button>
          <button class="tf-btn" data-tf="1d">1d</button>
        </div>
      </div>
      <div class="chart-container">
        <div id="chart-gold" class="chart-box"></div>
        <!-- Marca de agua LM -->
        <img src="/IMG_2975.png" alt="LM" class="lm-watermark" />
      </div>
      <div class="chart-footer">
        <span class="brand">LM Fondo Cotizado</span>
        <span class="ts" id="gold-upd">Actualizado: --/--/---- --:--</span>
      </div>
    </div>

    <!-- ====== PLATA ====== -->
    <div class="card" id="silver-card">
      <div class="card-head">
        <div class="title-sm">PLATA (XAG/USD)</div>
        <div class="subtitle">Tiempo real · LM Fondo Cotizado</div>
        <div class="big-price" id="silver-price">$--</div>
        <div class="tf-row" data-metal="XAG">
          <button class="tf-btn active" data-tf="1m">1m</button>
          <button class="tf-btn" data-tf="5m">5m</button>
          <button class="tf-btn" data-tf="15m">15m</button>
          <button class="tf-btn" data-tf="1h">1h</button>
          <button class="tf-btn" data-tf="4h">4h</button>
          <button class="tf-btn" data-tf="1d">1d</button>
        </div>
      </div>
      <div class="chart-container">
        <div id="chart-silver" class="chart-box"></div>
        <!-- Marca de agua LM -->
        <img src="/IMG_2975.png" alt="LM" class="lm-watermark" />
      </div>
      <div class="chart-footer">
        <span class="brand">LM Fondo Cotizado</span>
        <span class="ts" id="silver-upd">Actualizado: --/--/---- --:--</span>
      </div>
    </div>
  </div>

  <script>
    // ====== Util fecha ======
    const fmt2 = (n)=> String(n).padStart(2,"0");
    function fmtDate(ts){
      const d=new Date(ts);
      return `${fmt2(d.getDate())}/${fmt2(d.getMonth()+1)}/${d.getFullYear()} ${fmt2(d.getHours())}:${fmt2(d.getMinutes())}`;
    }

    // ====== Cargar spot (Metalprice por /api/spot) ======
    async function loadSpot(){
      const r = await fetch("/api/spot",{ cache:"no-store" });
      if(!r.ok) throw new Error("spot fail");
      return r.json();
    }
    function setHeaderPrices(g, s){
      document.getElementById("tk-gold").textContent   = `$${g.toFixed(2)}`;
      document.getElementById("tk-silver").textContent = `$${s.toFixed(2)}`;
      document.getElementById("gold-price").textContent   = `$${g.toFixed(2)}`;
      document.getElementById("silver-price").textContent = `$${s.toFixed(2)}`;
    }

    // ====== Charts ======
    function makeChart(dom){
      return LightweightCharts.createChart(dom,{
        layout:{ background:{ color:"#1a1a1a" }, textColor:"#fff" },
        grid:{ vertLines:{ color:"rgba(198,166,99,.06)" }, horzLines:{ color:"rgba(198,166,99,.06)" } },
        rightPriceScale:{ borderColor:"rgba(198,166,99,.35)" },
        timeScale:{ borderColor:"rgba(198,166,99,.35)" }
      });
    }
    function makeSeries(chart){
      return chart.addCandlestickSeries({
        upColor:"#00c853", downColor:"#d32f2f",
        borderUpColor:"#00c853", borderDownColor:"#d32f2f",
        wickUpColor:"#00c853", wickDownColor:"#d32f2f"
      });
    }

    const goldChart   = makeChart(document.getElementById("chart-gold"));
    const silverChart = makeChart(document.getElementById("chart-silver"));
    const goldSeries   = makeSeries(goldChart);
    const silverSeries = makeSeries(silverChart);

    // Generador simple de velas ancladas (si no tenés OHLC por minuto del proveedor)
    function genCandlesFromPrice(price, points=90, vol=0.0006){
      const now = Math.floor(Date.now()/1000);
      const out=[]; let last=price;
      for(let i=points;i>=0;i--){
        const t = now - i*60;           // 1m
        const delta = (Math.random()-0.5) * (price*vol);
        const open = last;
        const close = last + delta;
        const high = Math.max(open,close) + price*(vol*0.6);
        const low  = Math.min(open,close) - price*(vol*0.6);
        out.push({ time:t, open, high, low, close });
        last = close;
      }
      return out;
    }

    // Estado actual (una sola fuente = todo consistente)
    const STATE = { gold: 4000, silver: 50, ts: Date.now() };

    function applyTF(metal, tf){
      let pts=90, vol=0.0006;
      if(tf==="5m"){ pts=100; vol=0.00045; }
      if(tf==="15m"){ pts=120; vol=0.00035; }
      if(tf==="1h"){ pts=96; vol=0.00030; }
      if(tf==="4h"){ pts=72; vol=0.00024; }
      if(tf==="1d"){ pts=60; vol=0.00018; }

      if(metal==="XAU"){
        goldSeries.setData(genCandlesFromPrice(STATE.gold, pts, vol));
      }else{
        silverSeries.setData(genCandlesFromPrice(STATE.silver, pts, vol));
      }
    }

    document.querySelectorAll(".tf-row").forEach(row=>{
      const metal=row.getAttribute("data-metal");
      row.querySelectorAll(".tf-btn").forEach(btn=>{
        btn.addEventListener("click",()=>{
          row.querySelectorAll(".tf-btn").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          applyTF(metal, btn.getAttribute("data-tf"));
        });
      });
    });

    // Bootstrap
    (async ()=>{
      try{
        const spot = await loadSpot();
        if(spot?.gold?.price){ STATE.gold = spot.gold.price; }
        if(spot?.silver?.price){ STATE.silver = spot.silver.price; }
        STATE.ts = spot?.gold?.ts || Date.now();

        setHeaderPrices(STATE.gold, STATE.silver);
        document.getElementById("gold-upd").textContent   = "Actualizado: " + fmtDate(STATE.ts);
        document.getElementById("silver-upd").textContent = "Actualizado: " + fmtDate(STATE.ts);

        applyTF("XAU","1m");
        applyTF("XAG","1m");
      }catch(e){
        console.log("init spot error", e);
        applyTF("XAU","1m");
        applyTF("XAG","1m");
      }
    })();

    // Refresco cada 30s (misma fuente para mantener consistencia)
    setInterval(async ()=>{
      try{
        const spot = await loadSpot();
        if(spot?.gold?.price)   STATE.gold   = spot.gold.price;
        if(spot?.silver?.price) STATE.silver = spot.silver.price;
        STATE.ts = spot?.gold?.ts || Date.now();
        setHeaderPrices(STATE.gold, STATE.silver);

        // mantener timeframe seleccionado
        const gtf = document.querySelector('.tf-row[data-metal="XAU"] .tf-btn.active')?.getAttribute("data-tf") || "1m";
        const stf = document.querySelector('.tf-row[data-metal="XAG"] .tf-btn.active')?.getAttribute("data-tf") || "1m";
        applyTF("XAU", gtf);
        applyTF("XAG", stf);

        document.getElementById("gold-upd").textContent   = "Actualizado: " + fmtDate(STATE.ts);
        document.getElementById("silver-upd").textContent = "Actualizado: " + fmtDate(STATE.ts);
      }catch(e){ console.log("refresh spot error", e); }
    }, 30000);
  </script>
</body>
</html>
