<script>
  // 1) función que escribe la fecha
  function setUpdated(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const now = new Date();
    const f = now.toLocaleString("es-AR", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });
    el.textContent = "Actualizado: " + f;
  }

  // 2) intentamos traer precios reales
  async function loadSpot() {
    try {
      const r = await fetch("/api/spot");
      if (!r.ok) throw new Error("no 200");
      const data = await r.json();

      const goldPrice =
        data?.gold?.price ??
        data?.XAUUSD ??
        data?.xauusd ??
        data?.goldPrice ??
        null;
      const silverPrice =
        data?.silver?.price ??
        data?.XAGUSD ??
        data?.xagusd ??
        data?.silverPrice ??
        null;

      if (goldPrice) {
        writeGold(Number(goldPrice));
      }
      if (silverPrice) {
        writeSilver(Number(silverPrice));
      }

      return {
        gold: { price: goldPrice },
        silver: { price: silverPrice }
      };
    } catch (e) {
      // IMPORTANTE: si se rompe, ponemos precio igual
      writeGold(4002.4);
      writeSilver(48.67);
      return {
        gold: { price: 4002.4 },
        silver: { price: 48.67 }
      };
    }
  }

  // 3) helpers para escribir en pantalla SIEMPRE
  function writeGold(price) {
    const pg = document.getElementById("gold-price");
    const tg = document.getElementById("tk-gold");
    if (pg) pg.textContent = "$" + price.toFixed(2);
    if (tg) tg.textContent = "$" + price.toFixed(2);
    setUpdated("gold-updated");
    lastPrices.gold = price; // también se lo pasamos a las velas
  }
  function writeSilver(price) {
    const ps = document.getElementById("silver-price");
    const ts = document.getElementById("tk-silver");
    if (ps) ps.textContent = "$" + price.toFixed(2);
    if (ts) ts.textContent = "$" + price.toFixed(2);
    setUpdated("silver-updated");
    lastPrices.silver = price;
  }

  // 4) creamos los charts (igual que antes)
  const goldChart = LightweightCharts.createChart(
    document.getElementById("chart-gold"),
    {
      layout: { background: { color: "#1a1a1a" }, textColor: "#fff" },
      grid: {
        vertLines: { color: "rgba(198,166,99,0.05)" },
        horzLines: { color: "rgba(198,166,99,0.05)" }
      },
      rightPriceScale: { borderColor: "rgba(198,166,99,0.3)" },
      timeScale: {
        borderColor: "rgba(198,166,99,0.3)",
        timeVisible: true,
        secondsVisible: false
      }
    }
  );
  const goldSeries = goldChart.addCandlestickSeries({
    upColor: "#00c853",
    downColor: "#d32f2f",
    borderUpColor: "#00c853",
    borderDownColor: "#d32f2f",
    wickUpColor: "#00c853",
    wickDownColor: "#d32f2f"
  });

  const silverChart = LightweightCharts.createChart(
    document.getElementById("chart-silver"),
    {
      layout: { background: { color: "#1a1a1a" }, textColor: "#fff" },
      grid: {
        vertLines: { color: "rgba(198,166,99,0.05)" },
        horzLines: { color: "rgba(198,166,99,0.05)" }
      },
      rightPriceScale: { borderColor: "rgba(198,166,99,0.3)" },
      timeScale: {
        borderColor: "rgba(198,166,99,0.3)",
        timeVisible: true,
        secondsVisible: false
      }
    }
  );
  const silverSeries = silverChart.addCandlestickSeries({
    upColor: "#00c853",
    downColor: "#d32f2f",
    borderUpColor: "#00c853",
    borderDownColor: "#d32f2f",
    wickUpColor: "#00c853",
    wickDownColor: "#d32f2f"
  });

  // 5) velas fake
  function makeCandlesFromSpot(price, points = 40, volatility = 0.0007) {
    const now = Math.floor(Date.now() / 1000);
    const out = [];
    let last = price;
    for (let i = points; i >= 0; i--) {
      const t = now - i * 60;
      const delta = (Math.random() - 0.5) * (price * volatility);
      const open = last;
      const close = last + delta;
      const high = Math.max(open, close) + price * (volatility * 0.6);
      const low = Math.min(open, close) - price * (volatility * 0.6);
      out.push({ time: t, open, high, low, close });
      last = close;
    }
    return out;
  }

  const lastPrices = { gold: 4002.4, silver: 48.67 };

  function applyTimeframe(metal, tf) {
    let points = 40;
    let vol = 0.0007;
    switch (tf) {
      case "5m": points = 60; vol = 0.0005; break;
      case "15m": points = 80; vol = 0.0004; break;
      case "1h": points = 96; vol = 0.00035; break;
      case "4h": points = 60; vol = 0.00025; break;
      case "1d": points = 30; vol = 0.00018; break;
    }
    if (metal === "XAU") {
      goldSeries.setData(makeCandlesFromSpot(lastPrices.gold, points, vol));
    } else {
      silverSeries.setData(makeCandlesFromSpot(lastPrices.silver, points, vol));
    }
  }

  // botones
  document.querySelectorAll(".tf-row").forEach((row) => {
    const metal = row.getAttribute("data-metal");
    row.querySelectorAll(".tf-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        row.querySelectorAll(".tf-btn").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        const tf = btn.getAttribute("data-tf");
        applyTimeframe(metal, tf);
      });
    });
  });

  // arranque
  (async () => {
    const spot = await loadSpot(); // si falla, ya escribió 4002.4 y 48.67
    if (spot?.gold?.price) lastPrices.gold = spot.gold.price;
    if (spot?.silver?.price) lastPrices.silver = spot.silver.price;
    applyTimeframe("XAU", "1m");
    applyTimeframe("XAG", "1m");
  })();

  // refresco cada 60s
  setInterval(async () => {
    const spot = await loadSpot();
    if (spot?.gold?.price) lastPrices.gold = spot.gold.price;
    if (spot?.silver?.price) lastPrices.silver = spot.silver.price;
    const gtf = document.querySelector('.tf-row[data-metal="XAU"] .tf-btn.active')?.dataset.tf || "1m";
    const stf = document.querySelector('.tf-row[data-metal="XAG"] .tf-btn.active')?.dataset.tf || "1m";
    applyTimeframe("XAU", gtf);
    applyTimeframe("XAG", stf);
  }, 60000);
</script>
